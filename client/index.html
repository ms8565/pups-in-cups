<!DOCTYPE html>
<html lang="en">
<head>
    <script src="/socket.io/socket.io.js"></script>
    <script src="https://npmcdn.com/babel-core@5.8.38/browser.min.js"></script>
    <script type="text/babel" > 

        let socket;
        
        let players = {};
        let pups = [];
        let myPlayer;
        
        let canvas;
        let ctx;
        let dragging = false;
       
        let score = 0;
        let pupsMissed = 0;

        let showScores = false;
        let highScores = [];

        let startBtn;
        
        class Player {

            constructor(x){
                this.x = x;
                this.y = canvas.height-80;
                this.color = "red";
                this.id = 0;
                this.radius = 40;
            }
          isColliding(otherObj) {
            return (Math.pow((otherObj.x - this.x), 2) + Math.pow((otherObj.y - this.y), 2)) <= Math.pow((this.radius + otherObj.radius), 2);
          }
        };

        class StartBtn {
            constructor(x, y){
                this.x = x;
                this.y = y;
                this.img = "./assets/media/startBtn.png";
                this.hoverImg = "./assets/media/startBtn.png";
                this.height = 60;
                this.width = 200;
                this.hover = false;
                this.active = true;
            }
            pointInside(point){
                return (point.x >= this.x - this.width/2 && point.x <= this.x + this.width/2) && (point.y >= this.y - this.height/2 && point.y <= this.y + this.height/2);
            }
            onClick(){
                console.log("clicked!");
                socket.emit('startGame', { startGame: true });
            }
            draw(ctx){
                var btnImage = new Image();
                
                if(this.hover){
                    //ctx.fillStyle = "yellow";
                    //ctx.fillRect(this.x - this.width/2, this.y - this.height/2, this.width, this.height);
                    
                    btnImage.src = this.hoverImg;
                }
                else{
                   // ctx.fillStyle = "red";
                    //ctx.fillRect(this.x - this.width/2, this.y - this.height/2, this.width, this.height);
                    btnImage.src = this.img;
                }
                ctx.drawImage(btnImage, this.x - this.width/2, this.y - this.height/2, this.width, this.height);
            }
        }
        
        
        const init = (e) => {
            canvas = document.querySelector('canvas');
            ctx = canvas.getContext('2d');

            const join = document.querySelector("#join");
            join.addEventListener('click', checkJoinRoom);
            
            const create = document.querySelector("#create");
            create.addEventListener('click', checkCreateRoom);
            
            socket = io.connect();
            setupSocket();
        };
        window.onload = init;
        
        const setupSocket = (e) => {
            socket.on('connect', () => {
              //myPlayer = new Player(canvas.width / 2);
              //socket.emit('join', { newPlayer: myPlayer, roomName: "room1" });
              //startGame();
            });

            socket.on('joinRoom', (data) => {
                startGame(data.roomName);
                //myPlayer = new Player(canvas.width / 2);
                //socket.emit('join', { newPlayer: myPlayer, roomName: "room1" });
            });
            socket.on('denyRoom', (data) => {
                let errorText = document.querySelector("#error-text");
                errorText.innerHTML = data.message;
            });

        };

        const startGame = (room) => {
            let introScreen = document.querySelector("#intro-screen");
            introScreen.style.display = "none";
            
            let gameScreen = document.querySelector("#game-screen");
            gameScreen.style.display = "block";
            
            myPlayer = new Player(canvas.width / 2);
            socket.emit('join', { newPlayer: myPlayer, roomName: room });
            
            startBtn = new StartBtn(100,100);
            
            canvas.onmousedown = onMouseDown;
            canvas.onmouseup = onMouseUp;
            canvas.onmousemove = onMouseMove;

            socket.on('updateClientPlayers', (data) => {
                players = data.updatePlayers;
                draw();

            });
            socket.on('assignPlayer', (data) => {
                myPlayer.color = data.player.color;
                draw();

            });
            socket.on('updateClientPups', (data) => {
                pups = data.updateCPups;
                draw();
            });
            socket.on('updateClientScore', (data) => {
                score = data.serverScore;
                pupsMissed = data.serverMissed;
                draw();
            });
            socket.on('showStartUI', (data) => {
                startBtn.active = true;
                draw();
            });
            socket.on('showEndUI', (data) => {
                highScores = data.scores;
                showScores = true;
                startBtn.active = true;
                draw();
            });
            socket.on('hideUI', (data) => {
                showScores = false;
                startBtn.active = false;
                
                console.log("hide maybe??");
            });
        }

        const checkJoinRoom = () => {
            let roomInput = document.querySelector("#room-input").value;
            socket.emit('checkJoin', { roomName: roomInput });
        }
        const checkCreateRoom = () => {
            let roomInput = document.querySelector("#room-input").value;
            socket.emit('checkCreate', { roomName: roomInput });
        }
        
        const onMouseDown = (e) => {
            var mouse = {};
            mouse.x = e.pageX - e.target.offsetLeft;
            mouse.y = e.pageY - e.target.offsetTop;
            
            dragging = true;
            
            if(startBtn.active){
                if(startBtn.pointInside(mouse)){
                    startBtn.onClick();
                }
            }

        };
        const onMouseUp = (e) => {
            dragging = false;
        };
        const onMouseMove = (e) => {
            var mouse = {};
            mouse.x = e.pageX - e.target.offsetLeft;
            mouse.y = e.pageY - e.target.offsetTop;
            
            myPlayer.x = mouse.x;
            socket.emit('updateServerPlayers', { player: myPlayer });
            
            if(startBtn.active){
                if(startBtn.pointInside(mouse)){
                    startBtn.hover = true;
                }
                else{
                    startBtn.hover = false;
                }
            }
            draw();
            
        };
        
        const draw = (e) => {
          ctx.fillStyle = "white";
          ctx.fillRect(0, 0, canvas.width, canvas.height);

          for (var i in players) {
            ctx.save();
            ctx.fillStyle = players[i].color;
            //ctx.beginPath();
            //60, 34
            //ctx.arc(players[i].x, players[i].y, 40, 0, 2 * Math.PI, false)
            //ctx.fill();
            //ctx.stroke();
            var cupImage = new Image();
            cupImage.src = "https://people.rit.edu/ms8565/430/media/cup.png";
            ctx.drawImage(cupImage, players[i].x - 40, players[i].y, 80, 45);

            ctx.restore();
          }
          for (var i = 0; i < pups.length; i++) {
            ctx.save();

            ctx.fillStyle = pups[i].color;
            ctx.beginPath();
            ctx.arc(pups[i].x, pups[i].y, 20, 0, 2 * Math.PI, false)
            ctx.fill();
            ctx.stroke();

            ctx.restore();
          }

          ctx.fillStyle = "black";
          ctx.fillText("Score: "+score+" Pups Missed: "+pupsMissed, 60, 60);
            
          if(showScores){
              ctx.fillText("High Scores", 100, 180);
              for(var i = 0; i < highScores.length; i++){
                  ctx.fillStyle = "black";
                  ctx.fillText(i+1+". "+highScores[i][0]+": "+highScores[i][1], 100, 200 + i*10);
              }
          }
          if(startBtn.active){
              //draw start button
             startBtn.draw(ctx);
          }
        };
        
        
        
    
    </script>
</head>
<body>
    <div id="game-screen" style="display: none;">
        <canvas width="800" height="600">
            Your browser does not support Canvas
        </canvas>
    </div>
    
    <div id="intro-screen">
        <label for="room-name">Room Name:</label>
        <input id="room-input" name="room-name" type="text" />
        <input id="join" type='button' value='Join Room' />
        <input id="create" type='button' value='Create Room' />
        <p id="error-text"></p>
    </div>

    
</body>
</html>