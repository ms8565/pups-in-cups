<!DOCTYPE html>
<html lang="en">
<head>
    <script src="/socket.io/socket.io.js"></script>
    <script src="https://npmcdn.com/babel-core@5.8.38/browser.min.js"></script>
    <script type="text/javascript" > 

        let socket;
        
        let players = {};
        let pups = [];
        let myPlayer;
        
        let canvas;
        let ctx;
        let dragging = false;
       
        let score = 0;
        let pupsMissed = 0;
        
        class Player {

            constructor(x){
                this.x = x;
                this.y = canvas.height-80;
                this.color = "red";
                this.id = 0;
                this.radius = 40;
            }
          isColliding(otherObj) {
            return (Math.pow((otherObj.x - this.x), 2) + Math.pow((otherObj.y - this.y), 2)) <= Math.pow((this.radius + otherObj.radius), 2);
          }
        };
        
        
        const init = (e) => {
            canvas = document.querySelector('canvas');
            ctx = canvas.getContext('2d');

            canvas.onmousedown = onMouseDown;
            canvas.onmouseup = onMouseUp;
            canvas.onmousemove = onMouseMove;

            const join = document.querySelector("#join");
            join.addEventListener('click', checkJoinRoom);
            //startGame(); // to be removed
            
            socket = io.connect();
            setupSocket();
        };
        window.onload = init;
        
        const setupSocket = (e) => {
            socket.on('connect', () => {
              myPlayer = new Player(canvas.width / 2);
              socket.emit('join', { newPlayer: myPlayer, roomName: "room1" });
            });
            socket.on('updateClientPlayers', (data) => {
                console.log("but like actually updating players");
                players = data.updatePlayers;
                draw();

            });
            socket.on('assignPlayer', (data) => {
                console.log("player assigned in client");
                myPlayer.color = data.player.color;
                draw();

            });
            socket.on('updateClientPups', (data) => {
                pups = data.updateCPups;
                draw();
            });
            socket.on('updateClientScore', (data) => {
                score = data.serverScore;
                pupsMissed = data.serverMissed;
                draw();
            });
            


            /*socket.on('joinRoom', (data) => {
                startGame();
            });
            socket.on('denyRoom', (data) => {

            });*/

        };

        /*const startGame = () => {
            canvas = document.querySelector('canvas');
            ctx = canvas.getContext('2d');

            canvas.onmousedown = onMouseDown;
            canvas.onmouseup = onMouseUp;
            canvas.onmousemove = onMouseMove;

            socket.on('updateClientPlayers', (data) => {
                players = data.updatePlayers;
                draw();

            });
            socket.on('assignPlayer', (data) => {
                myPlayer.color = data.player.color;
                draw();

            });
            socket.on('updateClientPups', (data) => {
                pups = data.updateCPups;
                draw();
            });
            socket.on('updateClientScore', (data) => {
                score = data.serverScore;
                pupsMissed = data.serverMissed;
                draw();
            });
        }*/

        const checkJoinRoom = () => {
            let roomName = document.querySelector("#join-room-name").value;
        }
        
        const onMouseDown = (e) => {
            var mouse = {};
            mouse.x = e.pageX - e.target.offsetLeft;
            mouse.y = e.pageY - e.target.offsetTop;
            
            dragging = true;

        };
        const onMouseUp = (e) => {
            dragging = false;
        };
        const onMouseMove = (e) => {
            var mouse = {};
            mouse.x = e.pageX - e.target.offsetLeft;
            mouse.y = e.pageY - e.target.offsetTop;
            
            myPlayer.x = mouse.x;
            socket.emit('updateServerPlayers', { player: myPlayer });
            
        };
        
        const draw = (e) => {
          ctx.fillStyle = "white";
          ctx.fillRect(0, 0, canvas.width, canvas.height);

          for (var i in players) {
            ctx.save();
            ctx.fillStyle = players[i].color;
            //ctx.beginPath();
            //60, 34
            //ctx.arc(players[i].x, players[i].y, 40, 0, 2 * Math.PI, false)
            //ctx.fill();
            //ctx.stroke();
            var cupImage = new Image();
            cupImage.src = "https://people.rit.edu/ms8565/430/media/cup.png";
            ctx.drawImage(cupImage, players[i].x - 40, players[i].y, 80, 45);

            ctx.restore();
          }
          for (var i = 0; i < pups.length; i++) {
            ctx.save();

            ctx.fillStyle = pups[i].color;
            ctx.beginPath();
            ctx.arc(pups[i].x, pups[i].y, 20, 0, 2 * Math.PI, false)
            ctx.fill();
            ctx.stroke();

            ctx.restore();
          }

          ctx.fillStyle = "black";
          ctx.fillText("Score: "+score+" Pups Missed: "+pupsMissed, 60, 60);
        };
        
        
        
    
    </script>
</head>
<body>
    <game-screen>
        <canvas width="800" height="600">
            Your browser does not support Canvas
        </canvas>
    </game-screen>
    
    <intro-screen>
        <label for="join-room">Room Name:</label>
        <input id="join-room-name" name="join-room" type="text" />
        <input id="join" type='button' value='Join Room' />

        <label for="create-room">Room Name:</label>
        <input id="create-room-name" name="create-room" type="text" />
        <input id="create" type='button' value='Create Room' />
    </intro-screen>

    
</body>
</html>